<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aè‚¡å›æµ‹ç³»ç»Ÿ - æœ¬åœ°ç¼“å­˜ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .content {
            padding: 20px;
        }

        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab-button {
            padding: 10px 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #f5222d;
            color: white;
            width: 100%;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .cache-status {
            background: #f0f7ff;
            border-left: 3px solid #667eea;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .status-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .status-label {
            color: #666;
        }

        .status-value {
            color: #333;
            font-weight: bold;
        }

        .log-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .log-details {
            color: #666;
            font-size: 11px;
        }

        .results {
            background: #f9f9f9;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }

        .results.active {
            display: block;
        }

        .result-item {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .result-label {
            font-size: 12px;
            color: #999;
        }

        .result-value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        .stat-label {
            font-size: 11px;
            color: #999;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
            font-size: 12px;
        }

        .error.active {
            display: block;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
            font-size: 12px;
        }

        .success.active {
            display: block;
        }

        .warning {
            background: #fff3e0;
            color: #e65100;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
            font-size: 12px;
        }

        .warning.active {
            display: block;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 10px;
        }

        .table th {
            background: #f0f0f0;
            padding: 8px;
            text-align: left;
            font-weight: bold;
        }

        .table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .table tr:hover {
            background: #f9f9f9;
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
        }

        .radio-group input[type="radio"] {
            width: auto;
            margin-right: 8px;
            cursor: pointer;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .checkbox-group label:hover {
            background-color: #f0f0f0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            cursor: pointer;
        }

        .info-box {
            background-color: #e3f2fd;
            padding: 12px 15px;
            border-radius: 4px;
            margin: 15px 0;
            font-size: 13px;
            border-left: 3px solid #2196F3;
        }

        .btn-link {
            background: none;
            border: none;
            color: #2196F3;
            cursor: pointer;
            text-decoration: underline;
            padding: 0 5px;
            font-size: 13px;
        }

        .btn-link:hover {
            color: #1976D2;
        }

        .hint {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        @media (max-width: 480px) {
            .button-group {
                grid-template-columns: 1fr;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }

            .tab-buttons {
                flex-wrap: wrap;
            }

            .radio-group {
                flex-direction: column;
                gap: 10px;
            }

            .checkbox-group {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ˆ Aè‚¡å›æµ‹ç³»ç»Ÿ</h1>
            <p>æœ¬åœ°ç¼“å­˜ç‰ˆ - ç¦»çº¿å›æµ‹</p>
        </div>

        <div class="content">
            <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('data')">ğŸ“Š æ•°æ®ç®¡ç†</button>
                <button class="tab-button" onclick="switchTab('backtest')">ğŸ”„ å›æµ‹</button>
                <button class="tab-button" onclick="switchTab('status')">â„¹ï¸ çŠ¶æ€</button>
                <button class="tab-button" onclick="goToParameters()" style="margin-left: auto;">âš™ï¸ å‚æ•°é…ç½®</button>
            </div>

            <!-- æ ‡ç­¾é¡µ1: æ•°æ®ç®¡ç† -->
            <div class="tab-content active" id="data">
                <div class="section">
                    <div class="section-title">ğŸ“¥ æŒ‰æ¿å—è·å–æ•°æ®</div>

                    <div class="input-group">
                        <label>é€‰æ‹©æ¿å—</label>
                        <select id="sectorSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="">-- é€‰æ‹©æ¿å— --</option>
                        </select>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div class="input-group">
                            <label>å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" id="startDate" value="2024-01-01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div class="input-group">
                            <label>ç»“æŸæ—¥æœŸ</label>
                            <input type="date" id="endDate" value="2025-02-13" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>

                    <div class="info-box" style="background: #e8f5e9; border-left-color: #4caf50;">
                        âœ¨ <strong>è‡ªåŠ¨è·å–æ¨¡å¼</strong><br>
                        ç³»ç»Ÿå°†è‡ªåŠ¨è·å–è¯¥æ¿å—å…¨éƒ¨å¸‚åœºæ•°æ®ï¼Œä¸éœ€è¦æ‰‹åŠ¨è¾“å…¥ä¸ªæ•°<br>
                        <span style="font-size: 12px; color: #666;">
                        æ²ªæ·±Aè‚¡/æ·±æˆæŒ‡: ~100+åª | åˆ›ä¸šæ¿: ~80åª | ç§‘åˆ›æ¿: ~70åª | ä¸­è¯500: ~60åª
                        </span>
                    </div>

                    <button class="btn-primary" style="width: 100%;" onclick="batchFetchBySector()">ğŸš€ å¼€å§‹è·å–å…¨éƒ¨æ•°æ®</button>
                    <div id="batchSectorMessage"></div>
                </div>
            </div>

            <!-- æ ‡ç­¾é¡µ2: å›æµ‹ -->
            <div class="tab-content" id="backtest">
                <div class="section">
                    <div class="section-title">ğŸ”„ å›æµ‹è®¾ç½®</div>

                    <!-- å½“å‰ç­–ç•¥æ˜¾ç¤º -->
                    <div class="info-box" style="background: #f0f7ff; border-left-color: #667eea;">
                        ğŸ¯ å½“å‰ç­–ç•¥: <strong id="currentStrategyName">åŠ è½½ä¸­...</strong>
                        <button class="btn-link" onclick="goToParameters()">åˆ‡æ¢ç­–ç•¥</button>
                    </div>

                    <!-- ç¼“å­˜æ•°æ®ç»Ÿè®¡ -->
                    <div class="info-box">
                        ğŸ“Š å·²ç¼“å­˜ <strong id="cachedStockCount">0</strong> åªè‚¡ç¥¨æ•°æ®
                        <button class="btn-link" onclick="refreshCachedStocks()">åˆ·æ–°</button>
                    </div>

                    <!-- æ•°æ®é€‰æ‹©æ¨¡å¼ -->
                    <div class="input-group">
                        <label>é€‰æ‹©å›æµ‹æ•°æ®</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="backtestMode" value="manual" checked>
                                æ‰‹åŠ¨è¾“å…¥ä»£ç 
                            </label>
                            <label>
                                <input type="radio" name="backtestMode" value="all">
                                å…¨éƒ¨ç¼“å­˜æ•°æ®
                            </label>
                            <label>
                                <input type="radio" name="backtestMode" value="sector">
                                æŒ‰æ¿å—é€‰æ‹©
                            </label>
                        </div>
                    </div>

                    <!-- æ‰‹åŠ¨è¾“å…¥æ¡†ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->
                    <div id="manualInputSection" class="input-group">
                        <label>è¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰</label>
                        <input type="text" id="backtestCodes"
                               placeholder="å¦‚: 000001,600000,000858"
                               value="000001">
                    </div>

                    <!-- æ¿å—é€‰æ‹©åŒºï¼ˆé»˜è®¤éšè—ï¼‰ -->
                    <div id="sectorSelectSection" class="input-group" style="display: none;">
                        <label>é€‰æ‹©æ¿å—ï¼ˆå¯å¤šé€‰ï¼‰</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" value="æ²ªæ·±Aè‚¡" class="sector-checkbox"> æ²ªæ·±Aè‚¡</label>
                            <label><input type="checkbox" value="åˆ›ä¸šæ¿" class="sector-checkbox"> åˆ›ä¸šæ¿</label>
                            <label><input type="checkbox" value="ç§‘åˆ›æ¿" class="sector-checkbox"> ç§‘åˆ›æ¿</label>
                            <label><input type="checkbox" value="æ·±æˆæŒ‡" class="sector-checkbox"> æ·±æˆæŒ‡</label>
                            <label><input type="checkbox" value="ä¸­è¯500" class="sector-checkbox"> ä¸­è¯500</label>
                        </div>
                        <p class="hint" id="selectedStocksHint">è¯·é€‰æ‹©æ¿å—</p>
                    </div>

                    <button class="btn-primary" style="width: 100%;" onclick="runBacktestCache()">è¿è¡Œå›æµ‹</button>

                    <div class="loading" id="backtestLoading">
                        <div class="spinner"></div>
                        <p style="margin-top: 10px; font-size: 12px; color: #999;">å›æµ‹ä¸­...</p>
                    </div>

                    <div id="backtestMessage"></div>

                    <!-- å›æµ‹ç»“æœ -->
                    <div class="results" id="backtestResults">
                        <div class="section-title">ğŸ“ˆ å›æµ‹ç»“æœ</div>

                        <!-- æ˜¾ç¤ºä½¿ç”¨çš„ç­–ç•¥ -->
                        <div style="background: #f0f7ff; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 13px;">
                            <strong>ä½¿ç”¨ç­–ç•¥:</strong> <span id="resultStrategyName">-</span>
                        </div>

                        <div class="stat-grid">
                            <div class="stat-card">
                                <div class="stat-label">äº¤æ˜“ç¬”æ•°</div>
                                <div class="stat-value" id="resultTrades">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æ€»æ”¶ç›Šç‡</div>
                                <div class="stat-value" id="resultReturn">0%</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¹³å‡æ”¶ç›Š</div>
                                <div class="stat-value" id="resultAvg">0%</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">èƒœç‡</div>
                                <div class="stat-value" id="resultWinRate">0%</div>
                            </div>
                        </div>

                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ä»£ç </th>
                                    <th>ä¹°å…¥æ—¥æœŸ</th>
                                    <th>å–å‡ºæ—¥æœŸ</th>
                                    <th>æ”¶ç›Šç‡</th>
                                </tr>
                            </thead>
                            <tbody id="tradesTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- æ ‡ç­¾é¡µ3: çŠ¶æ€ -->
            <div class="tab-content" id="status">
                <div class="section">
                    <div class="section-title">ğŸ“Š ç¼“å­˜çŠ¶æ€</div>

                    <div class="cache-status">
                        <div class="status-row">
                            <div class="status-label">æ€»è®°å½•æ•°:</div>
                            <div class="status-value" id="totalRecords">-</div>
                        </div>
                        <div class="status-row">
                            <div class="status-label">æ•°æ®åº“å¤§å°:</div>
                            <div class="status-value" id="dbSize">-</div>
                        </div>
                        <div class="status-row">
                            <div class="status-label">æ•°æ®åº“ä½ç½®:</div>
                            <div class="status-value" id="dbFile" style="font-size: 10px; word-break: break-all;">-</div>
                        </div>
                    </div>

                    <div class="section-title">ğŸ“ æ›´æ–°æ—¥å¿—</div>
                    <div id="updateLogs"></div>

                    <div class="section-title" style="margin-top: 20px;">ğŸ—‘ï¸ å±é™©æ“ä½œ</div>
                    <button class="btn-danger" onclick="clearAllCache()">æ¸…ç©ºæ‰€æœ‰ç¼“å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡ï¼šç¼“å­˜æ•°æ®
        let cachedStocksData = {
            total: 0,
            stocks: [],
            by_sector: {}
        };

        // åŠ è½½ç¼“å­˜è‚¡ç¥¨æ•°æ®
        async function loadCachedStocks() {
            try {
                console.log('[DEBUG] å¼€å§‹åŠ è½½ç¼“å­˜è‚¡ç¥¨æ•°æ®...');
                const response = await fetch('/api/cache/stocks');
                console.log('[DEBUG] APIå“åº”çŠ¶æ€:', response.status);

                if (!response.ok) {
                    console.error('[ERROR] APIè¿”å›é”™è¯¯çŠ¶æ€:', response.status);
                    showMessage('backtestMessage', `APIé”™è¯¯: ${response.status}`, 'error');
                    return false;
                }

                const result = await response.json();
                console.log('[DEBUG] APIè¿”å›æ•°æ®:', result);
                console.log('[DEBUG] success:', result.success, ', total:', result.total);

                if (result.success) {
                    cachedStocksData = {
                        total: result.total,
                        stocks: result.stocks,
                        by_sector: result.by_sector
                    };

                    // æ›´æ–°UIæ˜¾ç¤º
                    const element = document.getElementById('cachedStockCount');
                    if (element) {
                        element.textContent = result.total;
                        console.log('[DEBUG] å·²æ›´æ–°UIæ˜¾ç¤º:', result.total);
                    } else {
                        console.error('[ERROR] æ‰¾ä¸åˆ°cachedStockCountå…ƒç´ ');
                    }
                    return true;
                } else {
                    console.error('[ERROR] APIè¿”å›å¤±è´¥:', result.error);
                    showMessage('backtestMessage', 'è·å–ç¼“å­˜æ•°æ®å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                    return false;
                }
            } catch (error) {
                console.error('[ERROR] åŠ è½½ç¼“å­˜æ•°æ®å¼‚å¸¸:', error);
                showMessage('backtestMessage', 'è·å–ç¼“å­˜æ•°æ®å‡ºé”™: ' + error.message, 'error');
                return false;
            }
        }

        // åˆ·æ–°ç¼“å­˜æ•°æ®
        async function refreshCachedStocks() {
            console.log('[DEBUG] ç”¨æˆ·ç‚¹å‡»åˆ·æ–°æŒ‰é’®');
            showMessage('backtestMessage', 'æ­£åœ¨åˆ·æ–°...', 'warning');
            const success = await loadCachedStocks();
            if (success) {
                const count = cachedStocksData.total;
                showMessage('backtestMessage', `âœ“ åˆ·æ–°æˆåŠŸï¼å½“å‰ç¼“å­˜ ${count} åªè‚¡ç¥¨`, 'success');
                console.log('[DEBUG] åˆ·æ–°æˆåŠŸ, è‚¡ç¥¨æ•°é‡:', count);
            } else {
                console.log('[DEBUG] åˆ·æ–°å¤±è´¥');
            }
        }

        // å›æµ‹æ¨¡å¼åˆ‡æ¢
        function setupBacktestModeSwitch() {
            const radios = document.querySelectorAll('input[name="backtestMode"]');
            const manualSection = document.getElementById('manualInputSection');
            const sectorSection = document.getElementById('sectorSelectSection');

            radios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const mode = e.target.value;

                    // æ˜¾ç¤º/éšè—å¯¹åº”çš„è¾“å…¥åŒºåŸŸ
                    manualSection.style.display = mode === 'manual' ? 'block' : 'none';
                    sectorSection.style.display = mode === 'sector' ? 'block' : 'none';

                    // æ›´æ–°æç¤ºä¿¡æ¯
                    if (mode === 'all') {
                        document.getElementById('selectedStocksHint').textContent =
                            `å°†å›æµ‹å…¨éƒ¨ ${cachedStocksData.total} åªè‚¡ç¥¨`;
                    }
                });
            });

            // æ¿å—é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°æç¤º
            const checkboxes = document.querySelectorAll('.sector-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedStocksHint);
            });
        }

        // æ›´æ–°å·²é€‰æ¿å—çš„è‚¡ç¥¨æç¤º
        function updateSelectedStocksHint() {
            const selectedSectors = getSelectedSectors();
            let totalStocks = 0;

            selectedSectors.forEach(sector => {
                totalStocks += (cachedStocksData.by_sector[sector] || []).length;
            });

            const hint = document.getElementById('selectedStocksHint');
            if (selectedSectors.length === 0) {
                hint.textContent = 'è¯·é€‰æ‹©æ¿å—';
            } else {
                hint.textContent = `å·²é€‰ ${selectedSectors.length} ä¸ªæ¿å—ï¼Œå…± ${totalStocks} åªè‚¡ç¥¨`;
            }
        }

        // è·å–å·²é€‰æ‹©çš„æ¿å—
        function getSelectedSectors() {
            const checkboxes = document.querySelectorAll('.sector-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'status') {
                updateCacheStatus();
            }
        }

        // è·³è½¬åˆ°å‚æ•°é…ç½®é¡µé¢
        function goToParameters() {
            window.location.href = '/parameters';
        }


        // åŠ è½½æ¿å—åˆ—è¡¨
        async function loadSectors() {
            try {
                const response = await fetch('/api/sectors');
                const result = await response.json();

                if (result.success) {
                    const sectorSelect = document.getElementById('sectorSelect');
                    result.sectors.forEach(sector => {
                        const option = document.createElement('option');
                        option.value = sector.key;
                        option.textContent = `${sector.name} - ${sector.description}`;
                        sectorSelect.appendChild(option);
                    });
                    // è®¾ç½®é»˜è®¤å€¼ä¸ºä¸­è¯500
                    sectorSelect.value = 'ä¸­è¯500';
                }
            } catch (error) {
                console.error('Failed to load sectors:', error);
            }
        }

        // æŒ‰æ¿å—æ‰¹é‡è·å–ï¼ˆè‡ªåŠ¨è·å–å…¨éƒ¨ï¼‰
        async function batchFetchBySector() {
            const sector = document.getElementById('sectorSelect').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!sector) {
                showMessage('batchSectorMessage', 'è¯·é€‰æ‹©æ¿å—', 'error');
                return;
            }

            showMessage('batchSectorMessage', `ğŸš€ æ­£åœ¨è·å–${sector}å…¨éƒ¨å¸‚åœºæ•°æ®...`, 'warning');

            try {
                const response = await fetch('/api/cache/batch-fetch-sector', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        sector: sector,
                        start_date: startDate.replace(/-/g, ''),
                        end_date: endDate.replace(/-/g, ''),
                        limit: null  // ä¸é™åˆ¶ï¼Œè·å–å…¨éƒ¨
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const stocksPreview = result.stocks && result.stocks.length > 0
                        ? result.stocks.slice(0, 5).join(', ')
                        : 'å·²è·å–';
                    showMessage('batchSectorMessage',
                        `âœ“ å·²å¼€å§‹è·å–${sector}å…¨éƒ¨æ•°æ®(å…±${result.stocks_count}åªè‚¡ç¥¨)ï¼\né¦–æ‰¹é¢„è§ˆ: ${stocksPreview}...`,
                        'success');
                } else {
                    showMessage('batchSectorMessage', `âœ— ${result.error || 'è·å–å¤±è´¥'}`, 'error');
                }
            } catch (error) {
                showMessage('batchSectorMessage', `âœ— ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        // å›æµ‹
        async function runBacktestCache() {
            try {
                showMessage('backtestMessage', '', 'error');
                document.getElementById('backtestLoading').classList.add('active');

                // æ ¹æ®é€‰æ‹©æ¨¡å¼è·å–è‚¡ç¥¨ä»£ç åˆ—è¡¨
                const mode = document.querySelector('input[name="backtestMode"]:checked').value;
                let symbols = [];

                if (mode === 'manual') {
                    // æ‰‹åŠ¨è¾“å…¥
                    const codes = document.getElementById('backtestCodes').value.trim();
                    if (!codes) {
                        showMessage('backtestMessage', 'è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ', 'error');
                        document.getElementById('backtestLoading').classList.remove('active');
                        return;
                    }
                    symbols = codes.split(',').map(s => s.trim()).filter(s => s);

                } else if (mode === 'all') {
                    // å…¨éƒ¨æ•°æ®
                    if (cachedStocksData.stocks.length === 0) {
                        showMessage('backtestMessage', 'æ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œè¯·å…ˆè·å–æ•°æ®', 'error');
                        document.getElementById('backtestLoading').classList.remove('active');
                        return;
                    }
                    symbols = cachedStocksData.stocks;

                } else if (mode === 'sector') {
                    // æŒ‰æ¿å—é€‰æ‹©
                    const selectedSectors = getSelectedSectors();
                    if (selectedSectors.length === 0) {
                        showMessage('backtestMessage', 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¿å—', 'error');
                        document.getElementById('backtestLoading').classList.remove('active');
                        return;
                    }

                    // åˆå¹¶é€‰ä¸­æ¿å—çš„æ‰€æœ‰è‚¡ç¥¨
                    selectedSectors.forEach(sector => {
                        const sectorStocks = cachedStocksData.by_sector[sector] || [];
                        symbols = symbols.concat(sectorStocks);
                    });

                    // å»é‡
                    symbols = [...new Set(symbols)];
                }

                if (symbols.length === 0) {
                    showMessage('backtestMessage', 'æ²¡æœ‰å¯å›æµ‹çš„è‚¡ç¥¨', 'error');
                    document.getElementById('backtestLoading').classList.remove('active');
                    return;
                }

                showMessage('backtestMessage',
                    `å¼€å§‹å›æµ‹ ${symbols.length} åªè‚¡ç¥¨ï¼Œè¯·ç¨å€™...`, 'warning');

                // è°ƒç”¨ç°æœ‰çš„å›æµ‹API
                const response = await fetch('/api/backtest/cache', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({symbols: symbols})
                });

                const result = await response.json();

                // æ˜¾ç¤ºç»“æœï¼ˆå¤ç”¨ç°æœ‰çš„displayBacktestResultså‡½æ•°ï¼‰
                if (result.success) {
                    displayBacktestResults(result);
                    showMessage('backtestMessage', 'âœ“ å›æµ‹å®Œæˆ', 'success');
                } else {
                    showMessage('backtestMessage', result.error || 'å›æµ‹å¤±è´¥', 'error');
                }

            } catch (error) {
                console.error('å›æµ‹å‡ºé”™:', error);
                showMessage('backtestMessage', 'å›æµ‹å‡ºé”™: ' + error.message, 'error');
            } finally {
                document.getElementById('backtestLoading').classList.remove('active');
            }
        }

        // æ˜¾ç¤ºå›æµ‹ç»“æœ
        function displayBacktestResults(result) {
            // æ˜¾ç¤ºç­–ç•¥åç§°
            if (result.strategy_name) {
                document.getElementById('resultStrategyName').textContent = result.strategy_name;
            }

            document.getElementById('resultTrades').textContent = result.total_trades;
            document.getElementById('resultReturn').textContent = result.total_return.toFixed(2) + '%';
            document.getElementById('resultAvg').textContent = result.avg_return.toFixed(2) + '%';
            document.getElementById('resultWinRate').textContent = result.win_rate.toFixed(1) + '%';

            const tbody = document.getElementById('tradesTable');
            tbody.innerHTML = result.trades.map(trade => `
                <tr>
                    <td>${trade.symbol}</td>
                    <td>${trade.buy_date}</td>
                    <td>${trade.sell_date}</td>
                    <td style="color: ${trade.return > 0 ? '#4caf50' : '#f44336'}">${trade.return > 0 ? '+' : ''}${trade.return}%</td>
                </tr>
            `).join('');

            document.getElementById('backtestResults').classList.add('active');
        }

        // æ›´æ–°ç¼“å­˜çŠ¶æ€
        async function updateCacheStatus() {
            try {
                const response = await fetch('/api/cache/status');
                const status = await response.json();

                if (status.success) {
                    document.getElementById('totalRecords').textContent = status.total_records;
                    document.getElementById('dbSize').textContent = status.db_size + ' MB';
                    document.getElementById('dbFile').textContent = status.db_file;

                    const logs = status.update_logs.map(log => `
                        <div class="log-item">
                            <div class="log-header">${log.symbol}</div>
                            <div class="log-details">
                                ğŸ“ ${log.record_count} æ¡æ•°æ® | æ›´æ–°äº ${log.last_date} | æœ€åæ›´æ–°: ${log.last_update}
                            </div>
                        </div>
                    `).join('');

                    document.getElementById('updateLogs').innerHTML = logs || '<p style="color: #999; font-size: 12px;">æš‚æ— æ•°æ®</p>';
                }
            } catch (error) {
                console.error('Failed to get cache status:', error);
            }
        }

        // æ¸…ç©ºç¼“å­˜
        async function clearAllCache() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¼“å­˜æ•°æ®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
                return;
            }

            try {
                const response = await fetch('/api/cache/clear', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });

                const result = await response.json();

                if (result.success) {
                    alert('âœ“ å·²æ¸…ç©ºç¼“å­˜');
                    updateCacheStatus();
                }
            } catch (error) {
                alert('âœ— é”™è¯¯: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            const prevEl = el.parentElement.querySelector('.error, .success, .warning');
            if (prevEl) prevEl.remove();

            const msgEl = document.createElement('div');
            msgEl.className = type;
            msgEl.textContent = message;
            msgEl.classList.add('active');
            el.after(msgEl);
        }

        // åŠ è½½å½“å‰ç­–ç•¥
        async function loadCurrentStrategy() {
            try {
                const response = await fetch('/api/strategies');
                const result = await response.json();

                if (result.success && result.strategies) {
                    const currentKey = result.current_strategy;
                    const strategy = result.strategies.find(s => s.key === currentKey);

                    if (strategy) {
                        document.getElementById('currentStrategyName').textContent = strategy.name;
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç­–ç•¥å¤±è´¥:', error);
                document.getElementById('currentStrategyName').textContent = 'åŠ è½½å¤±è´¥';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ›´æ–°çŠ¶æ€å’ŒåŠ è½½æ¿å—
        window.addEventListener('load', async () => {
            updateCacheStatus();
            loadSectors();
            loadCurrentStrategy();  // åŠ è½½å½“å‰ç­–ç•¥åç§°
            // åˆå§‹åŒ–å›æµ‹æ•°æ®é€‰æ‹©åŠŸèƒ½
            await loadCachedStocks();
            setupBacktestModeSwitch();
        });
    </script>
</body>
</html>
