# 📊 量化回测系统 V2.1 - 用户使用手册

## 🎯 系统简介

这是一个功能完整的**多策略量化交易回测系统**，支持：
- ✅ 4套内置量化策略（量能突破、稳健趋势、激进动量、平衡多因子）
- ✅ 真实市场数据获取（支持沪深A股、创业板、科创板等）
- ✅ 本地数据缓存（支持增量更新）
- ✅ 多板块批量回测
- ✅ 详细的回测报告和Excel导出
- ✅ Web可视化界面

---

## 🚀 快速开始

### 1️⃣ 环境要求

- **操作系统**：Windows 10/11、macOS、Linux
- **Python 版本**：Python 3.8 或更高
- **网络连接**：首次运行需要下载股票数据

### 2️⃣ 安装步骤

#### Windows 用户（推荐）

1. **双击运行** `安装依赖.bat`
   - 自动安装所有必要的 Python 包
   - 使用清华镜像源加速下载

2. **双击运行** `启动应用.bat`
   - 自动检查环境
   - 启动 Web 服务

3. **打开浏览器**访问 `http://localhost:5000`

#### Mac/Linux 用户

```bash
# 1. 安装依赖
pip install -r requirements_release.txt

# 2. 启动应用
python app_with_cache.py

# 3. 访问 http://localhost:5000
```

---

## 📚 功能说明

### 一、数据管理模块

#### 📥 获取股票数据

**位置**：数据管理 Tab

**功能**：
- 单只股票数据获取
- 按板块批量获取（沪深A股、创业板、科创板等）
- 支持自定义时间范围
- 数据自动缓存到本地数据库

**使用步骤**：
1. 选择板块（如"创业板"）
2. 设置数量限制（建议首次测试设为100）
3. 点击"批量获取数据"
4. 等待进度完成

**提示**：
- ⚠️ 首次获取全市场数据（3000只）可能需要 30-60 分钟
- ✅ 建议先测试少量股票（10-100只）
- ✅ 数据缓存后无需重复下载

---

### 二、回测模块

#### 🔍 运行回测

**位置**：回测模块 Tab

**回测模式**：

1. **全部股票回测**
   - 使用所有已缓存的股票数据
   - 适合评估策略的整体表现

2. **板块选择回测**
   - 选择特定板块（可多选）
   - 如：创业板 + 科创板

3. **手动输入回测**
   - 输入指定股票代码
   - 格式：`000001,600000,300750`（逗号分隔）

**策略选择**：

| 策略 | 特点 | 交易频率 | 风险 | 适用市场 |
|------|------|----------|------|----------|
| **量能突破回踩** | 经典策略，稳定可靠 | 中等 | 中低 | 全市场 |
| **稳健趋势跟随** | 低频交易，严格风控 | 低 | 低 | 蓝筹股 |
| **激进动量突破** | 高频快进快出 | 高 | 高 | 创业板/科创板 |
| **平衡多因子** | 多维度评分 | 中等 | 中 | 中证500 |

**参数调整**：

点击"策略参数配置"可调整：
- 均线周期
- 突破阈值
- 止损止盈比例
- 成交金额过滤范围

---

### 三、结果分析

#### 📊 回测报告

**关键指标**：

```
📈 总收益率：35.42%
💰 年化收益率：18.23%
📉 最大回撤：-12.5%
📊 夏普比率：1.45
🎯 胜率：62.3%
📈 盈亏比：2.1:1
🔄 交易次数：128 次
```

**指标说明**：

- **总收益率**：整个回测期间的总回报
- **年化收益率**：按年计算的平均收益
- **最大回撤**：最大亏损幅度（越小越好）
- **夏普比率**：收益风险比（>1 较好，>2 优秀）
- **胜率**：盈利交易占比
- **盈亏比**：平均盈利/平均亏损

#### 📥 导出Excel

**内容包含**：
- 汇总页：整体收益指标
- 交易记录：每笔交易详情
- 持仓记录：完整持仓历史
- 股票统计：各股票表现排名

**文件位置**：`backtest_results/` 目录

---

## ⚙️ 高级功能

### 策略参数优化

**位置**：策略参数配置页面

**可调参数示例**（量能突破策略）：

```python
{
    "short_window": 5,        # 短期均线周期（3-10天）
    "long_window": 20,        # 长期均线周期（10-60天）
    "volume_threshold": 1.5,  # 量能放大倍数（1.2-3.0）
    "pullback_percent": 3.0,  # 回踩幅度（1-10%）
    "stop_loss": 0.05,        # 止损比例（3-10%）
    "take_profit": 0.15,      # 止盈比例（10-30%）
    "turnover_min": 0.5,      # 最小成交金额（亿元）
    "turnover_max": 100.0     # 最大成交金额（亿元）
}
```

**参数说明**：

- `turnover_min/max`：成交金额过滤
  - 用于过滤不同流动性的股票
  - 小市值股票：0.01 ~ 1 亿
  - 中等市值：1 ~ 10 亿
  - 大市值：10 ~ 100 亿

---

## 🛠️ 常见问题

### Q1: 启动失败，提示缺少模块

**解决方案**：
```bash
# 重新安装依赖
pip install -r requirements_release.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### Q2: 获取数据失败

**可能原因**：
1. 网络连接问题
2. 股票代码不存在
3. API 限流

**解决方案**：
- 检查网络连接
- 稍后重试
- 减少并发请求数量

### Q3: 回测结果异常

**检查项**：
1. 确认已缓存足够的股票数据
2. 检查时间范围设置
3. 验证策略参数是否合理

### Q4: 数据库文件过大

**优化方案**：
```python
# 清理旧数据（可选）
python -c "from data_manager import DataManager; dm = DataManager(); dm.cleanup_old_data(days=365)"
```

---

## 📁 目录结构

```
stock_test/
├── app_with_cache.py          # 主应用入口
├── config.py                  # 配置文件
├── strategy.py                # 策略实现
├── backtest_engine.py         # 回测引擎
├── data_manager.py            # 数据管理
├── data_fetcher.py            # 数据获取
├── 启动应用.bat               # Windows 启动脚本
├── 安装依赖.bat               # Windows 安装脚本
├── requirements_release.txt   # 依赖列表
├── templates/                 # Web 界面模板
│   └── index_with_cache.html
├── data_cache/                # 本地数据缓存
│   └── stock_data.db          # SQLite 数据库
└── backtest_results/          # 回测结果导出
```

---

## 🔧 技术架构

```
┌─────────────────────────────────────────────┐
│            Web 界面 (Flask)                 │
├─────────────────────────────────────────────┤
│  数据管理层          │  回测引擎层          │
│  - DataManager      │  - BacktestEngine    │
│  - 缓存管理          │  - 信号生成          │
│  - 增量更新          │  - 交易模拟          │
├─────────────────────────────────────────────┤
│  策略层 (Strategy)                          │
│  - 量能突破  - 稳健趋势                     │
│  - 激进动量  - 平衡多因子                   │
├─────────────────────────────────────────────┤
│  数据层                                      │
│  - SQLite 数据库                            │
│  - efinance API                             │
│  - akshare API                              │
└─────────────────────────────────────────────┘
```

---

## 📞 支持与反馈

### 系统信息

- **版本**：V2.1
- **更新日期**：2025-02-14
- **Python 支持**：3.8+

### 问题反馈

如遇到问题，请提供以下信息：
1. 操作系统和 Python 版本
2. 错误提示截图
3. 操作步骤描述

---

## 📜 更新日志

### V2.1 (2025-02-14)
- ✅ 新增成交金额因子过滤
- ✅ 优化股票分类逻辑
- ✅ 修复批量获取性能问题
- ✅ 改进错误处理机制

### V2.0 (2025-02-14)
- ✅ 实现4套量化策略
- ✅ 新增策略参数配置API
- ✅ 支持多板块批量回测
- ✅ 完善数据缓存机制

---

## ⚠️ 免责声明

**本系统仅供学习和研究使用，不构成任何投资建议。**

- 回测结果不代表未来实际收益
- 实盘交易存在滑点、手续费等额外成本
- 历史数据不能完全预测市场走势
- 投资有风险，入市需谨慎

---

## 🎓 学习资源

**推荐阅读**：
- 《量化投资：策略与技术》
- 《Python金融大数据分析》
- 《海龟交易法则》

**相关文档**：
- [策略详细说明](STRATEGY_GUIDE.md)
- [API 接口文档](API_DOCUMENTATION.md)
- [开发者指南](DEVELOPMENT_GUIDE.md)

---

**祝您使用愉快！📈**
